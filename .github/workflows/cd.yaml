name: CD - Deploy to DigitalOcean VPS

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]

concurrency:
  group: cd-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy via SSH (git pull, build frontend, restart backend with pm2)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          command_timeout: 15m
          script: |
            set -e

            echo "Preparing SSH + GitHub host trust..."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts

            echo "Connected to VPS. Pulling latest changes..."
            cd /home/${{ secrets.EC2_USER }}/apps/Practice_CICD

            echo "Forcing origin remote to SSH..."
            git remote set-url origin git@github.com:${{ github.repository }}.git
            git pull 

            echo "Installing backend deps..."
            cd Practice_ec2_backend
            npm ci

            echo "Building frontend..."
            cd ../Practice_ec2_frontend
            npm ci
            npm run build

            echo "Starting/restarting backend with pm2..."
            cd ../Practice_ec2_backend

            command -v pm2 >/dev/null 2>&1 || { echo "pm2 not found on VPS. Install it: npm i -g pm2"; exit 1; }

            pm2 describe practice-backend >/dev/null 2>&1 && pm2 restart practice-backend || pm2 start server.js --name practice-backend

            pm2 save

            echo "pm2 status:"
            pm2 status
