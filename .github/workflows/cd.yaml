name: CD - Deploy to EC2 (10 min test window)

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]

concurrency:
  group: cd-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Deploy via SSH (git pull, build frontend, start server.js for 10 minutes)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || '22' }}
          command_timeout: 25m
          script: |
            set -e

            echo "Preparing SSH + GitHub host trust..."
            mkdir -p ~/.ssh
            chmod 700 ~/.ssh
            ssh-keyscan -H github.com >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts

            echo "Connected to EC2. Pulling latest changes..."
            cd /home/ubuntu/Practice_CICD

            echo "Forcing origin remote to SSH..."
            git remote set-url origin git@github.com:${{ github.repository }}.git

            git pull

            echo "Installing backend deps..."
            cd Practice_ec2_backend
            npm ci

            echo "Building frontend..."
            cd ../Practice_ec2_frontend
            npm ci
            npm run build

            echo "Starting backend server.js (10 min test window)..."
            cd ../Practice_ec2_backend

            pkill -f "node server.js" || true

            node server.js &
            SERVER_PID=$!

            echo "server.js started with PID=$SERVER_PID"

            trap 'echo "Got TERM/INT - stopping server.js..."; kill $SERVER_PID || true; exit 143' TERM INT

            echo "Keeping it alive for 10 minutes for testing..."
            for i in {1..20}; do
              echo "Still running... minute $((i/2))"
              sleep 30
            done

            echo "Stopping server.js..."
            kill $SERVER_PID || true

            echo "Done."
